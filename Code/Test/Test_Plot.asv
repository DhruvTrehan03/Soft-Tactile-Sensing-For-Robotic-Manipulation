clear; clc;

% Initialize the serial port for COM14 (Right Device)
right = serialport("COM14", 115200);
right.Timeout = 25; % Set a timeout to avoid indefinite waiting

% Send initialization command
write(right, "y", "string");

% Specify the number of readings
n = input("Enter the number of readings to collect: ");

% Buffers for first 10 readings (Calibration)
calibration_data = [];

% Buffers for storing scaled data
plotthis_right = zeros(1024,);

% Setup live plot
figure;
hold on;
grid on;
xlabel('Reading Number');
ylabel('Scaled Data');
title('Live Data from COM14');
h = animatedline('Color', 'b', 'LineWidth', 1.5);

for i = 1:n
    if i <= 10  % First 10 readings for calibration
        if right.NumBytesAvailable > 0  % Ensure data is available
            data_right = str2num(readline(right)); %#ok<ST2NM>
            if ~isempty(data_right)
                calibration_data = [calibration_data; data_right];
            end
        end
        disp(['Calibration Reading: ', num2str(i)]);
    else
        % Compute mean and std after the first 10 readings
        if i == 11 && ~isempty(calibration_data)
            mean_val = mean(calibration_data);
            std_val = std(calibration_data);
            disp(['Calibration Complete: Mean = ', num2str(mean_val), ', Std = ', num2str(std_val)]);
        end

        % Read and scale the data
            raw_data = str2num(readline(right)); %#ok<ST2NM>
            disp(raw_data)
            if ~isempty(raw_data) && exist('mean_val', 'var') && exist('std_val', 'var')
                scaled_data = (raw_data - mean_val) / std_val;
                
                % Store the scaled data
                plotthis_right = [plotthis_right; scaled_data];
                
                % Update live plot
                addpoints(h, i, scaled_data);
                drawnow;
            end
        disp(['Reading: ', num2str(i)]);
    end
end

% Save data
save_dir = 'C:\Users\dhruv\Soft-Tactile-Sensing-For-Robotic-Manipulation\Readings\';
if ~exist(save_dir, 'dir')
    mkdir(save_dir);
end
save(fullfile(save_dir, 'right.mat'), 'plotthis_right');

% Close the serial port safely
clear right;

disp('Data collection complete.');
